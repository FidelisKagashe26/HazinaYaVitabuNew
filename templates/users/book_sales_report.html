{% extends 'users/home.html' %}
{% load static %}
{% load custom_filters %}
{% load i18n %}

{% block header %}
{% trans "Book Sales Report" %} - {% trans "Hazina ya Vitabu" %}
{% endblock %}

{% block main_block %}
<div class="flex {% if theme == 'dark' %}bg-gray-900{% else %}bg-gray-50{% endif %} min-h-screen">
    <!-- Sidebar -->
    <div class="w-64 {% if theme == 'dark' %}bg-gray-800 border-gray-700{% else %}bg-white border-gray-200{% endif %} border-r shadow-lg">
        <div class="p-6">
            <h2 class="text-xl font-bold {% if theme == 'dark' %}text-blue-400{% else %}text-blue-700{% endif %} mb-6">{% trans "Seller Menu" %}</h2>
            <nav class="space-y-2">
                <a href="{% url 'seller_dashboard' %}" class="block p-3 rounded-lg {% if theme == 'dark' %}text-gray-300 hover:bg-gray-700{% else %}text-gray-700 hover:bg-gray-100{% endif %} transition duration-200">
                    <i class="bi bi-speedometer2 mr-2"></i>{% trans "Dashboard" %}
                </a>
                <a href="{% url 'daily_report' %}" class="block p-3 rounded-lg {% if theme == 'dark' %}text-gray-300 hover:bg-gray-700{% else %}text-gray-700 hover:bg-gray-100{% endif %} transition duration-200">
                    <i class="bi bi-calendar-check mr-2"></i>{% trans "Daily Report" %}
                </a>
                <a href="{% url 'book_sales_report' %}" class="block p-3 rounded-lg {% if theme == 'dark' %}bg-blue-600 text-white{% else %}bg-blue-100 text-blue-700{% endif %}">
                    <i class="bi bi-book mr-2"></i>{% trans "Book Sales" %}
                </a>
                <a href="{% url 'shop' %}" class="block p-3 rounded-lg {% if theme == 'dark' %}text-gray-300 hover:bg-gray-700{% else %}text-gray-700 hover:bg-gray-100{% endif %} transition duration-200">
                    <i class="bi bi-bag mr-2"></i>{% trans "View Products" %}
                </a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-8">
        <!-- Header Section -->
        <header class="mb-8 pb-6 border-b-2 {% if theme == 'dark' %}border-blue-400{% else %}border-blue-400{% endif %}">
            <h1 class="text-4xl font-extrabold {% if theme == 'dark' %}text-blue-400{% else %}text-blue-800{% endif %}">{% trans "Book Sales Report" %}</h1>
            <p class="text-lg mt-3 {% if theme == 'dark' %}text-gray-300{% else %}text-gray-700{% endif %}">
                {% trans "Record individual book sales for" %} {{ today|date:"F d, Y" }}
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Add Book Sale Form -->
            <div class="{% if theme == 'dark' %}bg-gray-800 border-gray-700{% else %}bg-white{% endif %} p-6 rounded-lg shadow-lg border">
                <h2 class="text-2xl font-bold {% if theme == 'dark' %}text-blue-400{% else %}text-blue-700{% endif %} mb-4">{% trans "Record Book Sale" %}</h2>
                
                {% if messages %}
                    {% for message in messages %}
                        <div class="mb-4 p-4 rounded {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-300{% else %}bg-red-100 text-red-800 border border-red-300{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
                
                <form method="post" class="space-y-4">
                    {% csrf_token %}
                    
                    <div>
                        <label for="product" class="block text-sm font-medium {% if theme == 'dark' %}text-gray-300{% else %}text-gray-700{% endif %} mb-2">{% trans "Select Book" %}</label>
                        <select name="product" id="product" required
                                class="w-full p-3 border {% if theme == 'dark' %}border-gray-600 bg-gray-700 text-white focus:border-blue-400{% else %}border-gray-300 focus:border-blue-500{% endif %} rounded-lg focus:outline-none">
                            <option value="">{% trans "Choose a book..." %}</option>
                            {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }} - {{ product.price|format_currency }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="quantity_sold_money" class="block text-sm font-medium {% if theme == 'dark' %}text-gray-300{% else %}text-gray-700{% endif %} mb-2">{% trans "Sold for Money" %}</label>
                            <input type="number" name="quantity_sold_money" id="quantity_sold_money" min="0" 
                                   class="w-full p-3 border {% if theme == 'dark' %}border-gray-600 bg-gray-700 text-white focus:border-blue-400{% else %}border-gray-300 focus:border-blue-500{% endif %} rounded-lg focus:outline-none" 
                                   value="0" required>
                        </div>
                        
                        <div>
                            <label for="quantity_given_free" class="block text-sm font-medium {% if theme == 'dark' %}text-gray-300{% else %}text-gray-700{% endif %} mb-2">{% trans "Given for Free" %}</label>
                            <input type="number" name="quantity_given_free" id="quantity_given_free" min="0" 
                                   class="w-full p-3 border {% if theme == 'dark' %}border-gray-600 bg-gray-700 text-white focus:border-blue-400{% else %}border-gray-300 focus:border-blue-500{% endif %} rounded-lg focus:outline-none" 
                                   value="0" required>
                        </div>
                    </div>
                    
                    <div>
                        <label for="sale_price" class="block text-sm font-medium {% if theme == 'dark' %}text-gray-300{% else %}text-gray-700{% endif %} mb-2">{% trans "Sale Price per Book" %}</label>
                        <input type="number" name="sale_price" id="sale_price" min="0" step="0.01" 
                               class="w-full p-3 border {% if theme == 'dark' %}border-gray-600 bg-gray-700 text-white focus:border-blue-400{% else %}border-gray-300 focus:border-blue-500{% endif %} rounded-lg focus:outline-none" 
                               value="0" required>
                    </div>
                    
                    <div>
                        <label for="notes" class="block text-sm font-medium {% if theme == 'dark' %}text-gray-300{% else %}text-gray-700{% endif %} mb-2">{% trans "Notes" %}</label>
                        <textarea name="notes" id="notes" rows="3" 
                                  class="w-full p-3 border {% if theme == 'dark' %}border-gray-600 bg-gray-700 text-white focus:border-blue-400{% else %}border-gray-300 focus:border-blue-500{% endif %} rounded-lg focus:outline-none" 
                                  placeholder="{% trans 'Additional notes about this sale...' %}"></textarea>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                        {% trans "Record Sale" %}
                    </button>
                </form>
            </div>

            <!-- Today's Book Sales -->
            <div class="{% if theme == 'dark' %}bg-gray-800 border-gray-700{% else %}bg-white{% endif %} p-6 rounded-lg shadow-lg border">
                <h2 class="text-2xl font-bold {% if theme == 'dark' %}text-blue-400{% else %}text-blue-700{% endif %} mb-4">{% trans "Today's Book Sales" %}</h2>
                
                {% if today_reports %}
                    <div class="space-y-4 max-h-96 overflow-y-auto">
                        {% for report in today_reports %}
                        <div class="{% if theme == 'dark' %}bg-gray-700 border-gray-600{% else %}bg-gray-50 border-gray-200{% endif %} p-4 rounded-lg border">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-semibold {% if theme == 'dark' %}text-white{% else %}text-gray-800{% endif %}">{{ report.product.name }}</h3>
                                <span class="{% if theme == 'dark' %}text-blue-400{% else %}text-blue-600{% endif %} font-semibold">{{ report.total_revenue|format_currency }}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="{% if theme == 'dark' %}text-gray-300{% else %}text-gray-600{% endif %}">{% trans "Sold" %}: <span class="font-semibold text-green-600">{{ report.quantity_sold_money }} {% trans "copies of" %} {{ report.product.name }}</span></div>
                                <div class="{% if theme == 'dark' %}text-gray-300{% else %}text-gray-600{% endif %}">{% trans "Free" %}: <span class="font-semibold text-blue-600">{{ report.quantity_given_free }} {% trans "copies of" %} {{ report.product.name }}</span></div>
                                <div class="{% if theme == 'dark' %}text-gray-300{% else %}text-gray-600{% endif %}">{% trans "Price" %}: <span class="font-semibold">{{ report.sale_price|format_currency }}</span></div>
                                <div class="{% if theme == 'dark' %}text-gray-300{% else %}text-gray-600{% endif %}">{% trans "Revenue" %}: <span class="font-semibold text-green-600">{{ report.total_revenue|format_currency }}</span></div>
                            </div>
                            {% if report.notes %}
                                <p class="{% if theme == 'dark' %}text-gray-400{% else %}text-gray-500{% endif %} text-sm mt-2">{{ report.notes }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Summary -->
                    <div class="mt-6 p-4 {% if theme == 'dark' %}bg-blue-900 border-blue-700{% else %}bg-blue-50 border-blue-200{% endif %} border rounded-lg">
                        <h3 class="font-bold {% if theme == 'dark' %}text-blue-300{% else %}text-blue-700{% endif %} mb-2">{% trans "Today's Summary" %}</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>{% trans "Different Books Sold" %}: <span class="font-semibold">{{ today_reports|length }}</span></div>
                            <div>{% trans "Total Revenue" %}: <span class="font-semibold text-green-600">
                                {% widthratio today_reports.0.total_revenue 1 1 %}{% for report in today_reports %}{% if not forloop.first %}{% widthratio report.total_revenue 1 1 %}{% endif %}{% endfor %}
                            </span></div>
                        </div>
                    </div>
                {% else %}
                    <p class="{% if theme == 'dark' %}text-gray-400{% else %}text-gray-500{% endif %}">{% trans "No book sales recorded today." %}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Auto-fill sale price when product is selected
document.getElementById('product').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption.value) {
        const priceText = selectedOption.text.split(' - ')[1];
        if (priceText) {
            const price = priceText.replace('Tsh ', '').replace('/=', '').replace(',', '');
            document.getElementById('sale_price').value = parseFloat(price) || 0;
        }
    }
});
</script>
{% endblock %}